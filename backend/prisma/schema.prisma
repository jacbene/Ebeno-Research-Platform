
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String    @id @default(cuid())
  name              String?
  email             String    @unique
  passwordHash      String
  role              UserRole  @default(RESEARCHER)
  isVerified        Boolean   @default(false)
  verificationToken String?
  resetToken        String?
  resetTokenExpiry  DateTime?

  plan   UserPlan?

  profile                        Profile?
  createdProjects                Project[]              @relation("ProjectOwner")
  projectMemberships             ProjectMember[]
  transcriptions                 Transcription[]
  aiAnalyses                     AIAnalysis[]
  documents                      Document[]
  codes                          Code[]
  annotations                    Annotation[]
  memos                          Memo[]
  surveys                        Survey[]
  surveyResponses                SurveyResponse[]
  fieldNotes                     FieldNote[]
  createdCollaborationSessions   CollaborationSession[] @relation("SessionCreator")
  collaborationSessions          CollaborationSession[] @relation("CollaborationParticipant")
  collaborationComments          CollaborationComment[]
  collaborationCursors           CollaborationCursor[]
  collaborationHistory           CollaborationHistory[]
  submittedPeerReviewSubmissions PeerReviewSubmission[] @relation("Submissions")
  assignedPeerReviewSubmissions  PeerReviewSubmission[] @relation("Reviewers")
  peerReviews                    PeerReview[]           @relation("Reviews")
  apiKeys                        ApiKey[]
  references                     Reference[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

model UserPlan {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planType       PlanType @default(FREE)
  startedAt      DateTime @default(now())
  endsAt         DateTime?
  usage          Json? // { transcriptions: 3, analyses: 100 }
  stripeCustomerId String?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

model Profile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName         String
  lastName          String
  avatar            String?
  discipline        String
  affiliation       String?
  bio               String?
  researchInterests String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id                    String                 @id @default(cuid())
  title                 String
  description           String?
  status                ProjectStatus          @default(ACTIVE)
  visibility            Visibility             @default(PRIVATE)
  owner                 User                   @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId               String
  members               ProjectMember[]
  tags                  ProjectTag[]
  transcriptions        Transcription[]
  aiAnalyses            AIAnalysis[]
  documents             Document[]
  codes                 Code[]
  memos                 Memo[]
  references            Reference[]
  folders               Folder[]
  surveys               Survey[]
  fieldNotes            FieldNote[]
  collaborationSessions CollaborationSession[]
  reviewCriteria        ReviewCriteria[]
  webhooks              Webhook[]
  annotations           Annotation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([status])
}

model ProjectMember {
  id        String      @id @default(cuid())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  role      ProjectRole @default(VIEWER)
  joinedAt  DateTime    @default(now())

  @@unique([projectId, userId])
}

model ProjectTag {
  id        String  @id @default(cuid())
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId     String

  @@unique([projectId, tagId])
}

model Tag {
  id       String       @id @default(cuid())
  name     String
  category String? // 'system', 'user', 'discipline'
  color    String?
  projects ProjectTag[]
  references ReferenceTag[]

  @@unique([name, category])
}

model Transcription {
  id             String              @id @default(cuid())
  title          String
  description    String?
  fileUrl        String
  fileName       String
  fileSize       Int
  duration       Int?
  mimeType       String
  language       String              @default("fr-FR")
  status         TranscriptionStatus @default(PENDING)
  progress       Int                 @default(0)
  errorMessage   String?
  transcriptText String?
  words          Json?
  speakers       Json?
  project        Project?            @relation(fields: [projectId], references: [id])
  projectId      String?
  createdBy      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  aiAnalyses     AIAnalysis[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  processedAt    DateTime?
  annotations    Annotation[]
  memos          Memo[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
}

model AIAnalysis {
  id              String         @id @default(cuid())
  type            AnalysisType
  content         Json
  prompt          String?
  model           String
  cost            Float?
  duration        Int?
  transcription   Transcription? @relation(fields: [transcriptionId], references: [id], onDelete: Cascade)
  transcriptionId String?
  document        Document?      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId      String?
  project         Project?       @relation(fields: [projectId], references: [id])
  projectId       String?
  createdBy       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  createdAt DateTime @default(now())
}

model Document {
  id                    String                 @id @default(cuid())
  title                 String
  content               String                 @db.Text
  type                  DocumentType           @default(NOTE)
  project               Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId             String
  createdBy             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  aiAnalyses            AIAnalysis[]
  annotations           Annotation[]
  memos                 Memo[]
  collaborationSessions CollaborationSession[]

  @@index([projectId])
  @@index([type])
}

enum UserRole {
  RESEARCHER
  ADMIN
}

enum ProjectStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum Visibility {
  PRIVATE
  TEAM
  PUBLIC
}

enum ProjectRole {
  OWNER
  EDITOR
  VIEWER
  MEMBER
}

enum TranscriptionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum AnalysisType {
  TRANSCRIPTION_SUMMARY
  TOPIC_EXTRACTION
  SENTIMENT_ANALYSIS
  CODE_SUGGESTION
  RESEARCH_QUESTIONS
  METHODOLOGY_SUGGESTION
  COLLABORATION_INSIGHTS
}

enum DocumentType {
  NOTE
  LITERATURE_REVIEW
  MEETING_MINUTES
  RESEARCH_LOG
  ARTICLE_DRAFT
}

enum CollaborationRole {
  ADMIN
  MEMBER
  VIEWER
}

enum CollaborationStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  ARCHIVED
  CANCELLED
}

model Code {
  id          String       @id @default(cuid())
  name        String
  description String?
  color       String       @default("#3b82f6")
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId    String?
  parent      Code?        @relation("CodeHierarchy", fields: [parentId], references: [id])
  children    Code[]       @relation("CodeHierarchy")
  annotations Annotation[]
  memos       Memo[]
  createdBy   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, name])
  @@index([projectId])
  @@index([parentId])
}

model Annotation {
  id              String         @id @default(cuid())
  codeId          String
  code            Code           @relation(fields: [codeId], references: [id], onDelete: Cascade)
  documentId      String?
  document        Document?      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  transcriptionId String?
  transcription   Transcription? @relation(fields: [transcriptionId], references: [id], onDelete: Cascade)
  startIndex      Int
  endIndex        Int
  selectedText    String
  notes           String?
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  memos           Memo[]

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentId])
  @@index([transcriptionId])
  @@index([codeId])
  @@index([userId])
  @@index([projectId])
}

model Memo {
  id              String         @id @default(cuid())
  title           String
  content         String         @db.Text
  projectId       String
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  codeId          String?
  code            Code?          @relation(fields: [codeId], references: [id], onDelete: SetNull)
  documentId      String?
  document        Document?      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  transcriptionId String?
  transcription   Transcription? @relation(fields: [transcriptionId], references: [id], onDelete: Cascade)
  annotationId    String?
  annotation      Annotation?    @relation(fields: [annotationId], references: [id], onDelete: Cascade)
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([codeId])
  @@index([userId])
}

model Reference {
  id          String       @id @default(cuid())
  title       String
  author      String
  year        Int
  journal     String?
  volume      String?
  issue       String?
  pages       String?
  doi         String?
  url         String?
  abstract    String?
  notes       String?
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  attachments Attachment[]
  tags        ReferenceTag[]
  userId      String?
  user        User?        @relation(fields: [userId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model ReferenceTag {
  id        String    @id @default(cuid())
  reference Reference @relation(fields: [referenceId], references: [id], onDelete: Cascade)
  referenceId String
  tag       Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId     String

  @@unique([referenceId, tagId])
}

model Folder {
  id          String       @id @default(cuid())
  name        String
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId    String?
  parent      Folder?      @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    Folder[]     @relation("FolderHierarchy")
  attachments Attachment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Attachment {
  id          String    @id @default(cuid())
  filename    String
  url         String
  mimeType    String
  size        Int
  referenceId String
  reference   Reference @relation(fields: [referenceId], references: [id], onDelete: Cascade)
  folderId    String?
  folder      Folder?   @relation(fields: [folderId], references: [id])
  createdAt   DateTime  @default(now())
}

model Survey {
  id          String           @id @default(cuid())
  title       String
  description String?
  projectId   String
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  questions   Question[]
  responses   SurveyResponse[]
  createdBy   User             @relation(fields: [userId], references: [id])
  userId      String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Question {
  id       String       @id @default(cuid())
  text     String
  questionType QuestionType
  options  String[]
  surveyId String
  survey   Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  answers  Answer[]
  order    Int
}

enum QuestionType {
  TEXT
  MULTIPLE_CHOICE
  SINGLE_CHOICE
  SCALE
}

model SurveyResponse {
  id        String   @id @default(cuid())
  surveyId  String
  survey    Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  answers   Answer[]
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Answer {
  id         String         @id @default(cuid())
  responseId String
  response   SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  questionId String
  question   Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  value      String
}

model FieldNote {
  id        String       @id @default(cuid())
  title     String
  content   String       @db.Text
  location  Json?
  projectId String
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  media     FieldMedia[]
  createdBy User         @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model FieldMedia {
  id          String    @id @default(cuid())
  filename    String
  url         String
  mimeType    String
  size        Int
  fieldNoteId String
  fieldNote   FieldNote @relation(fields: [fieldNoteId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
}

enum CollaborationSessionType {
  DOCUMENT
  MEMO
  ARTICLE
  REPORT
}

model Webhook {
  id          String      @id @default(cuid())
  url         String
  event       String
  secret      String?
  enabled     Boolean     @default(true)
  project     Project?    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String?
  description String?
  headers     Json?
  retryCount  Int         @default(3)
  timeout     Int         @default(5000)

  lastTriggeredAt DateTime?
  
  logs        WebhookLog[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@unique([url, event, projectId])
  @@index([projectId])
  @@index([event])
  @@index([enabled])
}

model WebhookLog {
  id          String    @id @default(cuid())
  webhook     Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  webhookId   String
  event       String
  payload     Json
  responseCode Int?
  response    String?
  error       String?
  retryCount  Int       @default(0)
  attemptedAt DateTime  @default(now())
  completedAt DateTime?
  
  @@index([webhookId])
  @@index([attemptedAt])
  @@index([responseCode])
}

model CollaborationSession {
  id      String                   @id @default(cuid())
  title   String
  type    CollaborationSessionType
  content String                   @default("")
  version Int                      @default(1)

  project      Project   @relation(fields: [projectId], references: [id])
  projectId    String
  document     Document? @relation(fields: [documentId], references: [id])
  documentId   String?
  createdBy    User      @relation("SessionCreator", fields: [createdById], references: [id])
  createdById  String
  participants User[]    @relation("CollaborationParticipant")

  isActive     Boolean                @default(true)
  isPublic     Boolean                @default(false)
  shareLink    String?                @unique
  lastActivity DateTime               @default(now())
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  comments     CollaborationComment[]
  cursors      CollaborationCursor[]
  history      CollaborationHistory[]

  @@index([projectId])
  @@index([createdById])
  @@index([isActive])
}

model CollaborationComment {
  id       String @id @default(cuid())
  content  String
  position Json?

  session   CollaborationSession   @relation(fields: [sessionId], references: [id])
  sessionId String
  user      User                   @relation(fields: [userId], references: [id])
  userId    String
  parent    CollaborationComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  parentId  String?
  replies   CollaborationComment[] @relation("CommentReplies")

  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@index([parentId])
}

model CollaborationCursor {
  id        String @id @default(cuid())
  position  Json
  selection Json?

  session   CollaborationSession @relation(fields: [sessionId], references: [id])
  sessionId String
  user      User                 @relation(fields: [userId], references: [id])
  userId    String

  lastActive DateTime @default(now())

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

model CollaborationHistory {
  id String @id @default(cuid())

  session   CollaborationSession @relation(fields: [sessionId], references: [id])
  sessionId String
  user      User                 @relation(fields: [userId], references: [id])
  userId    String

  operations    Json
  versionBefore Int
  versionAfter  Int

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
}

enum ReviewStatus {
  DRAFT
  SUBMITTED
  COMPLETED
  ARCHIVED
}

enum ReviewDecision {
  ACCEPT
  MINOR_REVISION
  MAJOR_REVISION
  REJECT
}

model PeerReviewSubmission {
  id            String       @id @default(cuid())
  title         String
  abstract      String?
  documentId    String
  projectId     String
  submittedById String
  submittedBy   User         @relation("Submissions", fields: [submittedById], references: [id])
  status        ReviewStatus @default(SUBMITTED)

  reviewers User[]       @relation("Reviewers")
  reviews   PeerReview[]

  deadline      DateTime?
  isBlindReview Boolean   @default(true)
  isDoubleBlind Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([submittedById])
  @@index([status])
}

model PeerReview {
  id String @id @default(cuid())

  submission   PeerReviewSubmission @relation(fields: [submissionId], references: [id])
  submissionId String
  reviewer     User                 @relation("Reviews", fields: [reviewerId], references: [id])
  reviewerId   String

  score           Int?
  comments        String
  decision        ReviewDecision
  strengths       String[]
  weaknesses      String[]
  recommendations String[]

  status ReviewStatus @default(SUBMITTED)

  submittedAt DateTime               @default(now())
  reviewedAt  DateTime?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  ratings     ReviewCriteriaRating[]

  @@unique([submissionId, reviewerId])
  @@index([submissionId])
  @@index([reviewerId])
}

model ReviewCriteria {
  id          String @id @default(cuid())
  name        String
  description String
  weight      Float  @default(1.0)

  project   Project                @relation(fields: [projectId], references: [id])
  projectId String
  ratings   ReviewCriteriaRating[]

  createdAt DateTime @default(now())

  @@index([projectId])
}

model ReviewCriteriaRating {
  id String @id @default(cuid())

  review     PeerReview     @relation(fields: [reviewId], references: [id])
  reviewId   String
  criteria   ReviewCriteria @relation(fields: [criteriaId], references: [id])
  criteriaId String

  score    Int
  comments String?

  @@unique([reviewId, criteriaId])
  @@index([reviewId])
  @@index([criteriaId])
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyHash     String   @unique
  scopes      String[]
  revokedAt   DateTime?
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  logs        ApiLog[]

  @@index([userId])
}

model ApiLog {
  id           String   @id @default(cuid())
  userId       String
  apiKeyId     String
  apiKey       ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  endpoint     String
  method       String
  ipAddress    String
  userAgent    String
  status       Int
  responseTime Int
  requestSize  Int
  queryParams  String
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([apiKeyId])
}
